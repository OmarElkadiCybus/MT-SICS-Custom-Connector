description: MT-SICS Weighing Scale Service

metadata:
  name: mtsics-weighing-scale-service

parameters:
  AgentName:
    type: string
    description: The protocol-mapper agent name where the MT-SICS connector is running
    default: MtsicsAgent

  DeviceHost:
    type: string
    description: IP address or DNS name of the MT-SICS enabled scale
    default: localhost

  DevicePort:
    type: integer
    description: Listening TCP port of the scale
    default: 4305

  ConnectionInitialDelayMs:
    type: integer
    description: Initial wait before the first reconnect attempt (ms)
    default: 1000

  ConnectionMaxDelayMs:
    type: integer
    description: Upper bound for the reconnect backoff delay (ms)
    default: 60000

  ConnectionBackoffFactor:
    type: number
    description: Multiplier applied to the reconnect delay after every failure
    default: 2

resources:
  scaleConnection:
    type: Cybus::Connection
    properties:
      protocol: Mtsics
      agentName: !ref AgentName
      connection:
        host: !ref DeviceHost
        port: !ref DevicePort
        # pollingInterval: !ref PollingInterval # REMOVED
        connectionStrategy:
          initialDelayMs: !ref ConnectionInitialDelayMs
          maxDelayMs: !ref ConnectionMaxDelayMs
          backoffFactor: !ref ConnectionBackoffFactor
      
  # Endpoint for on-demand reading of the stable weight (no polling)
  readWeightEndpoint:
    type: Cybus::Endpoint
    properties:
      protocol: Mtsics
      connection: !ref scaleConnection
      subscribe:
        command: 'S'
        interval: 10000 # NEW: Polling every 1000ms for this endpoint
      agentName: !ref AgentName

  # # Endpoint for taring the scale
  # tareScaleEndpoint:
  #   type: Cybus::Endpoint
  #   properties:
  #     protocol: Mtsics
  #     connection: !ref scaleConnection
  #     write:
  #       address:
  #         command: 'T'
  #     agentName: !ref AgentName

  # # Endpoint for zeroing the scale
  # zeroScaleEndpoint:
  #   type: Cybus::Endpoint
  #   properties:
  #     protocol: Mtsics
  #     connection: !ref scaleConnection
  #     write:
  #       address:
  #         command: 'Z'
  #     agentName: !ref AgentName
